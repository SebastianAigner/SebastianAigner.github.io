<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Setting up a CUPS / AirPrint Server on Raspberry Pi</title>
  <meta name="description" content="Even though I’ve switched almost my whole office experience to paperless, my parents are still very much heavy users of the printer. However, with the recent...">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/jekyll/update/2017/12/18/setting-up-cups-server.html">
  <link rel="alternate" type="application/rss+xml" title="sebi.io" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">sebi.io</a>
  
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
            <a class="page-link" href="/about/">About</a>
            
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Setting up a CUPS / AirPrint Server on Raspberry Pi</h1>
    <p class="post-meta">
      <time datetime="2017-12-18T00:00:00+01:00" itemprop="datePublished">
        
        Dec 18, 2017
      </time>
      </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Even though I’ve switched almost my whole office experience to paperless, my parents are still very much heavy users of the printer. However, with the recent diversification of even their technology, and the growing need to print from a Windows machine, a Macbook and an iPad, I knew it was necessary to find a unified way to print from all those devices. The answer proved to be a <em>CUPS (formerly Common UNIX Printing System)</em> server on a Raspberry Pi that I had lying around.</p>

<h3 id="prerequisites">Prerequisites</h3>
<p>I set up my Raspberry Pi with the latest version of Raspbian. I made sure the packages <code class="highlighter-rouge">vim</code> and <code class="highlighter-rouge">git</code> are installed on the device (if they are not, you can simply install them via your old friend <code class="highlighter-rouge">apt-get</code>).</p>

<h3 id="installation">Installation</h3>
<p>First, we check whether our printer is actually being recognized by the system (the main prerequisite for the rest of the tutorial to work)</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">lsusb</code></pre></figure>

<p>Now that we’ve verified this, we can run</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>apt-get install cups</code></pre></figure>

<p>and install the CUPS server and its dependencies. This can take a while.</p>

<p>Next, we modify the user account to properly function with the CUPS authentication:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>usermod <span class="nt">-aG</span> lpadmin pi</code></pre></figure>

<p>This concludes the installation. Now all we need to do is to configure the web frontend to be accessible.</p>

<h3 id="configuration">Configuration</h3>
<p>Now, it’s time to set up the cofiguration of your CUPS service to be available outside of localhost. So, fire up your favorite text editor (in my case <code class="highlighter-rouge">vim</code>, but feel free to go full <code class="highlighter-rouge">emacs</code> or <code class="highlighter-rouge">nano</code> if you prefer), and open <code class="highlighter-rouge">/etc/cups/cupsd.conf</code>.</p>

<p>Find the line that says</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Listen localhost:631
</code></pre></div></div>

<p>and replace it with</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Port 631
</code></pre></div></div>

<p>At the first block, set</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WebInterface Yes
ServerAlias *
</code></pre></div></div>

<p>afterwards, set all the <code class="highlighter-rouge">Allow @local</code> annotations for the locations block, like so:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt; Location / &gt;
	# Restrict access to the server...
	Order allow,deny
	Allow @local
	&lt; /Location &gt;
	
	&lt; Location /admin &gt;
	# Restrict access to the admin pages...
	Order allow,deny
	Allow @local
	&lt; /Location &gt;
	
	&lt; Location /admin/conf &gt;
	AuthType Default
	Require user @SYSTEM
	
	# Restrict access to the configuration files...
	Order allow,deny
	Allow @local
	&lt; /Location &gt;
</code></pre></div></div>

<p>If you’ve followed the steps above, you’re pretty much done with your installation; restart the CUPS server by invoking <code class="highlighter-rouge">sudo /etc/init.d/cups restart</code>.</p>

<p>You can now add the printer via the webinterface; the login will be the same as it is for your Raspbian installation.</p>

<h3 id="but-what-about-airprint">But what about AirPrint?</h3>

<p>To setup AirPrint, we need to install another package called <code class="highlighter-rouge">avahi-discover</code>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>apt-get install avahi-discover</code></pre></figure>

<p>And we are done… kind of.</p>

<h3 id="troubleshooting-rgb-printer-issues">Troubleshooting RGB Printer Issues</h3>

<p>In my case, when printing some documents, the printer would just not run. A short investigation in the web interface would reveal the issue:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"(urftopdf) die(Invalid ColorSpace, only RGB 24BIT type 1 is supported) [Success]"
</code></pre></div></div>
<p>Nothing like a <code class="highlighter-rouge">[Success]</code> error message, am I right? I dug deep into some ancient forums and figured out that the <code class="highlighter-rouge">urftopdf</code> that comes bundled with CUPS apparently is not the most current version, and that it lacks the support for the color space I was requiring. So, I decided to <em>compile my own urftopdf</em>! What might sound daunting at first is actually quite straightforward and can be done with the few commands below:</p>

<p>First, we grab ourselves a version of urftopdf which actually supports the colorspace we need:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git clone https://github.com/superna9999/urftopdf</code></pre></figure>

<p>Then, we install a few dependencies without which the compilation is destined to fail:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>apt-get install libhpdf-dev libcups2-dev libcupsimage2-dev g++ cups-client</code></pre></figure>

<p>Now, we <code class="highlighter-rouge">cd</code> into the <code class="highlighter-rouge">urftopdf</code> folder and execute the <code class="highlighter-rouge">make</code> command. Now, all that is left is to back up our old <code class="highlighter-rouge">urftopdf</code> installation and replace it with the new one, which is merely two lines to enter:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>mv /usr/lib/cups/filter/urftopdf /usr/lib/cups/filter/urftopdf.old
<span class="nb">sudo </span>cp urftopdf /usr/lib/cups/filter</code></pre></figure>

<p>This should take effect immediately - if it doesn’t, restart CUPS using the command mentioned above, and everything should be great.</p>

<p>Installing the printers under Windows and Mac should be a breeze, iOS devices should autodiscover the devices.</p>

<h3 id="advantages-and-drawbacks">Advantages and Drawbacks</h3>
<p>After having deployed this solution for a while, I’ve noticed a few drawbacks, but also advantages. Printing from a Windows machine <em>flies</em>, it is the same speed as if you would just have the printer attached to the machine directly. From Apple based devices, the CUPS server has to do some recomputations, which take a long time. When printing a page that is only 5 pages long and does not have too many complex SVG shapes, this is fine - so if your main use case is just printing out an email or an excerpt from Wikipedia. However, when printing very complex documents (e.g. a mindmap you drew on your iPad) that has a lot of small individual shapes, or a document that is very long (if you’re on a tree killing spree and print out your ebooks), you’ll have an unfeasibly long wait time.</p>

  </div>

  
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">sebi.io</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              sebi.io
            
            </li>
            
            <li><a href="mailto:[firstname] döt [lastname]@me.com">[firstname] döt [lastname]@me.com</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/SebastianAigner"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">SebastianAigner</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/TrueSebi"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">TrueSebi</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>This is my corner of the internet. Tech makes me happy, so I try to note down and share my adventures here. I don&#39;t have a really specific plan on where I am going with this, so I&#39;ll use it as my notepad to jot down ideas, concepts, and tutorials, so that I and others will be able to revisit them whenever they&#39;d like.</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
