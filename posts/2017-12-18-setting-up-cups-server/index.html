<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta property="og:title" content="Setting up a CUPS / AirPrint Server on Raspberry Pi"><meta property="og:description" content="Even though I&rsquo;ve switched almost my whole office experience to paperless, my parents are still very much heavy users of the printer. However, with the recent diversification of even their technology, and the growing need to print from a Windows machine, a Macbook and an iPad, I knew it was necessary to find a unified way to print from all those devices. The answer proved to be a CUPS (formerly Common UNIX Printing System) server on a Raspberry Pi that I had lying around."><meta property="og:type" content="article"><meta property="og:url" content="https://sebi.io/posts/2017-12-18-setting-up-cups-server/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-12-18T00:00:00+00:00"><meta property="article:modified_time" content="2017-12-18T00:00:00+00:00"><title>Setting up a CUPS / AirPrint Server on Raspberry Pi | Sebastian Aigner</title><link rel=stylesheet href=https://sebi.io/sass/main.1062dd691b84b3ea042cce5aecb22abbae6d1a58288b48fbcb72443c8f1930dd.css integrity="sha256-EGLdaRuEs+oELM5a7LIqu65tGlgoi0j7y3JEPI8ZMN0=" crossorigin=anonymous><script src=/js/main.23cd0c7d837263b9eaeb96ee2d9ccfa2969daa3fa00fa1c1fe8701a9b87251a1.js integrity="sha256-I80MfYNyY7nq65buLZzPopadqj+gD6HB/ocBqbhyUaE=" crossorigin=anonymous></script></head><body><header class=site-header><div class=wrapper><a class=site-title rel=author href=/>Sebastian Aigner</a><nav class=site-nav><input type=checkbox id=nav-trigger class=nav-trigger>
<label for=nav-trigger><span class=menu-icon><svg viewBox="0 0 18 15" width="18" height="15"><path d="M18 1.484c0 .82-.665 1.484-1.484 1.484H1.484C.665 2.969.0 2.304.0 1.484.0.665.665.0 1.484.0h15.032C17.335.0 18 .665 18 1.484zm0 6.032C18 8.335 17.335 9 16.516 9H1.484C.665 9 0 8.335.0 7.516c0-.82.665-1.484 1.484-1.484h15.032C17.335 6.031 18 6.696 18 7.516zm0 6C18 14.335 17.335 15 16.516 15H1.484C.665 15 0 14.335.0 13.516c0-.82.665-1.483 1.484-1.483h15.032C17.335 12.031 18 12.695 18 13.516z"/></svg></span></label><div class=trigger><a class=page-link href=/>Home</a>
<a class=page-link href=/micro/>Microblah</a>
<a class=page-link aria-current=true class=ancestor href=/posts/>Posts</a>
<a class=page-link href=/tags/>Tags</a></div></nav></div></header><main class=page-content aria-label=Content><div class=wrapper><header class=post-header><h1 class="post-title p-name" itemprop="name headline">Setting up a CUPS / AirPrint Server on Raspberry Pi</h1><p class=post-meta><time class=dt-published datetime=2017-12-18T00:00:00+00:00>December 18, 2017</time></p></header><div class="post-content e-content"><p>Even though I&rsquo;ve switched almost my whole office experience to paperless, my parents are still very much heavy users of the printer. However, with the recent diversification of even their technology, and the growing need to print from a Windows machine, a Macbook and an iPad, I knew it was necessary to find a unified way to print from all those devices. The answer proved to be a <em>CUPS (formerly Common UNIX Printing System)</em> server on a Raspberry Pi that I had lying around.</p><h3 id=prerequisites>Prerequisites</h3><p>I set up my Raspberry Pi with the latest version of Raspbian. I made sure the packages <code>vim</code> and <code>git</code> are installed on the device (if they are not, you can simply install them via your old friend <code>apt-get</code>).</p><h3 id=installation>Installation</h3><p>First, we check whether our printer is actually being recognized by the system (the main prerequisite for the rest of the tutorial to work)</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lsusb</span></span></code></pre></div><p>Now that we&rsquo;ve verified this, we can run<div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt-get install cups</span></span></code></pre></div>and install the CUPS server and its dependencies. This can take a while.</p><p>Next, we modify the user account to properly function with the CUPS authentication:<div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo usermod -aG lpadmin pi</span></span></code></pre></div></p><p>This concludes the installation. Now all we need to do is to configure the web frontend to be accessible.</p><h3 id=configuration>Configuration</h3><p>Now, it&rsquo;s time to set up the cofiguration of your CUPS service to be available outside of localhost. So, fire up your favorite text editor (in my case <code>vim</code>, but feel free to go full <code>emacs</code> or <code>nano</code> if you prefer), and open <code>/etc/cups/cupsd.conf</code>.</p><p>Find the line that says</p><pre tabindex=0><code>Listen localhost:631
</code></pre><p>and replace it with</p><pre tabindex=0><code>Port 631
</code></pre><p>At the first block, set</p><pre tabindex=0><code>WebInterface Yes
ServerAlias *
</code></pre><p>afterwards, set all the <code>Allow @local</code> annotations for the locations block, like so:</p><pre tabindex=0><code>&lt; Location / &gt;
	# Restrict access to the server...
	Order allow,deny
	Allow @local
	&lt; /Location &gt;
	
	&lt; Location /admin &gt;
	# Restrict access to the admin pages...
	Order allow,deny
	Allow @local
	&lt; /Location &gt;
	
	&lt; Location /admin/conf &gt;
	AuthType Default
	Require user @SYSTEM
	
	# Restrict access to the configuration files...
	Order allow,deny
	Allow @local
	&lt; /Location &gt;
</code></pre><p>If you&rsquo;ve followed the steps above, you&rsquo;re pretty much done with your installation; restart the CUPS server by invoking <code>sudo /etc/init.d/cups restart</code>.</p><p>You can now add the printer via the webinterface; the login will be the same as it is for your Raspbian installation.</p><h3 id=but-what-about-airprint>But what about AirPrint?</h3><p>To setup AirPrint, we need to install another package called <code>avahi-discover</code>:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt-get install avahi-discover</span></span></code></pre></div><p>And we are done&mldr; kind of.</p><h3 id=troubleshooting-rgb-printer-issues>Troubleshooting RGB Printer Issues</h3><p>In my case, when printing some documents, the printer would just not run. A short investigation in the web interface would reveal the issue:</p><pre tabindex=0><code>&#34;(urftopdf) die(Invalid ColorSpace, only RGB 24BIT type 1 is supported) [Success]&#34;
</code></pre><p>Nothing like a <code>[Success]</code> error message, am I right? I dug deep into some ancient forums and figured out that the <code>urftopdf</code> that comes bundled with CUPS apparently is not the most current version, and that it lacks the support for the color space I was requiring. So, I decided to <em>compile my own urftopdf</em>! What might sound daunting at first is actually quite straightforward and can be done with the few commands below:</p><p>First, we grab ourselves a version of urftopdf which actually supports the colorspace we need:<div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/superna9999/urftopdf</span></span></code></pre></div>Then, we install a few dependencies without which the compilation is destined to fail:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt-get install libhpdf-dev libcups2-dev libcupsimage2-dev g++ cups-client</span></span></code></pre></div><p>Now, we <code>cd</code> into the <code>urftopdf</code> folder and execute the <code>make</code> command. Now, all that is left is to back up our old <code>urftopdf</code> installation and replace it with the new one, which is merely two lines to enter:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo mv /usr/lib/cups/filter/urftopdf /usr/lib/cups/filter/urftopdf.old
</span></span><span style=display:flex><span>sudo cp urftopdf /usr/lib/cups/filter</span></span></code></pre></div><p>This should take effect immediately - if it doesn&rsquo;t, restart CUPS using the command mentioned above, and everything should be great.</p><p>Installing the printers under Windows and Mac should be a breeze, iOS devices should autodiscover the devices.</p><h3 id=advantages-and-drawbacks>Advantages and Drawbacks</h3><p>After having deployed this solution for a while, I&rsquo;ve noticed a few drawbacks, but also advantages. Printing from a Windows machine <em>flies</em>, it is the same speed as if you would just have the printer attached to the machine directly. From Apple based devices, the CUPS server has to do some recomputations, which take a long time. When printing a page that is only 5 pages long and does not have too many complex SVG shapes, this is fine - so if your main use case is just printing out an email or an excerpt from Wikipedia. However, when printing very complex documents (e.g. a mindmap you drew on your iPad) that has a lot of small individual shapes, or a document that is very long (if you&rsquo;re on a tree killing spree and print out your ebooks), you&rsquo;ll have an unfeasibly long wait time.</p></div></div></main><footer><footer class="site-footer h-card"><data class=u-url href></data><div class=wrapper><div class=footer-col-wrapper><div class=footer-col><p class=feed-subscribe><svg class="svg-icon orange"/><span>Subscribe</span></a></p><ul class=contact-list></ul></div><div class=footer-col><p>Thanks for stopping by my corner of the internet :)</p></div></div></div></footer></footer></body></html>