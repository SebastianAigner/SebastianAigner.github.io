<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Migrating our Kotlin/JS app to the new IR compiler | Sebastian Aigner</title><link rel=stylesheet href=https://sebi.io/sass/main.1062dd691b84b3ea042cce5aecb22abbae6d1a58288b48fbcb72443c8f1930dd.css integrity="sha256-EGLdaRuEs+oELM5a7LIqu65tGlgoi0j7y3JEPI8ZMN0=" crossorigin=anonymous><script src=/js/main.23cd0c7d837263b9eaeb96ee2d9ccfa2969daa3fa00fa1c1fe8701a9b87251a1.js integrity="sha256-I80MfYNyY7nq65buLZzPopadqj+gD6HB/ocBqbhyUaE=" crossorigin=anonymous></script></head><body><header class=site-header><div class=wrapper><a class=site-title rel=author href=/>Sebastian Aigner</a><nav class=site-nav><input type=checkbox id=nav-trigger class=nav-trigger>
<label for=nav-trigger><span class=menu-icon><svg viewBox="0 0 18 15" width="18" height="15"><path d="M18 1.484c0 .82-.665 1.484-1.484 1.484H1.484C.665 2.969.0 2.304.0 1.484.0.665.665.0 1.484.0h15.032C17.335.0 18 .665 18 1.484zm0 6.032C18 8.335 17.335 9 16.516 9H1.484C.665 9 0 8.335.0 7.516c0-.82.665-1.484 1.484-1.484h15.032C17.335 6.031 18 6.696 18 7.516zm0 6C18 14.335 17.335 15 16.516 15H1.484C.665 15 0 14.335.0 13.516c0-.82.665-1.483 1.484-1.483h15.032C17.335 12.031 18 12.695 18 13.516z"/></svg></span></label><div class=trigger><a class=page-link href=/>Home</a>
<a class=page-link href=/micro/>Microblah</a>
<a class=page-link aria-current=true class=ancestor href=/posts/>Posts</a>
<a class=page-link href=/tags/>Tags</a></div></nav></div></header><main class=page-content aria-label=Content><div class=wrapper><header class=post-header><h1 class="post-title p-name" itemprop="name headline">Migrating our Kotlin/JS app to the new IR compiler</h1><p class=post-meta><time class=dt-published datetime=2021-03-09T00:00:00+00:00>March 9, 2021</time></p></header><div class="post-content e-content"><p>Together with some colleagues, I maintain a small <strong>full-stack web application</strong> called CodeQuiz, which we built during a <a href=https://blog.jetbrains.com/blog/2019/11/22/jetbrains-7th-annual-hackathon/>48-hour hackathon at JetBrains</a>, and use at <a href="https://www.youtube.com/watch?v=_AM5VbPTKeg">events</a> to gamify learning about Kotlin. I recently <strong>migrated its frontend</strong> which you can see below (and which is using the <a href=https://github.com/JetBrains/kotlin-wrappers/tree/master/kotlin-react><code>kotlin-react</code> wrappers</a>) to the <strong>new Kotlin/JS IR compiler backend</strong>.</p><p><img src=/assets/migrating-kotlin-js-ir/7bteuocjmnzyj2fi3ovm.gif alt="CodeQuiz in action"></p><p>The new compiler made a bunch of issues in our code visible, so I wanted to <strong>share my experience</strong> of migrating a Kotlin/JS app, and provide some <strong>hints</strong> on where to look when your app behaves unexpectedly after moving to the IR compiler.</p><h2 id=whats-the-kotlinjs-ir-compiler>What&rsquo;s the Kotlin/JS IR compiler?</h2><p>The <a href=https://kotlinlang.org/docs/js-ir-compiler.html>Kotlin/JS IR compiler</a> is currently in development (with alpha stability) and on its way to become <strong>the new default</strong> way of compiling Kotlin to JavaScript. It&rsquo;s a completely re-engineered infrastructure for all things Kotlin/JS. This switch comes with a <strong>number of benefits</strong> for Kotlin/JS applications!</p><p><img src=/assets/migrating-kotlin-js-ir/jsirtweet.png alt></p><p>Using it allows you to already <strong>test drive</strong> a bunch of <strong>new features</strong>, including <a href=https://kotlinlang.org/docs/js-ir-compiler.html#preview-generation-of-typescript-declaration-files-d-ts><strong>TypeScript declaration generation</strong></a>, and profit from <strong>new optimizations</strong> like stronger DCE (and, as a result, <strong>smaller generated artifacts</strong>).</p><p>But it also means that you have to embrace its <strong>more strict rules</strong> regarding <strong>interoperation</strong> between Kotlin and JavaScript. This might <strong>require some adjustment</strong> at first, but will help write more predictable code that interoperates between Kotlin and JavaScript.</p><h2 id=why-doesnt-my-code-_just-work_->Why doesn&rsquo;t my code <em>just work</em>? ðŸ˜±</h2><p>Especially with code at the &ldquo;boundary&rdquo; between Kotlin and JavaScript, <strong>the legacy compiler was quite lenient</strong> â€“ for example how it exported all symbols (e.g. a <code>data class</code>) from Kotlin code to the JavaScript world.</p><p>Unfortunately, this means that it was easy to rely on compiler-specific internal behavior â€“ <strong>some things just <em>happened</em> to work, even though the compiler gave no guarantees that these things <em>were supposed to work</em></strong>.</p><p>When using the IR compiler these <strong>mistakes become visible</strong> â€“ it enforces <strong>proper, explicit interoperation</strong> between the world of Kotlin and the world of JavaScript (we call this the <strong>&ldquo;Closed World&rdquo; model</strong>). This stricter and more explicit control will help the compiler <strong>optimize your code</strong> more aggressively.</p><p>But, due to the nature of JavaScript being a dynamic runtime environment, some of these changes in behavior only appear <strong>during execution time</strong>. In the case of CodeQuiz, a number of modifications were necessary to get everything working. We&rsquo;ll look at them in detail in the next sections.</p><p>Ultimately, it boiled down to <strong>running and testing</strong> the application (both in <code>development</code> and <code>production</code> mode), and keeping an eye on the following:</p><ul><li>Helping Kotlin&rsquo;s DCE via <code>@JsExport</code> (e.g. React components)</li><li>Using <code>external interface</code> to define React properties (<code>RProps</code>) and state (<code>RState</code>) (instead of (<code>data</code>) <code>class</code>es) and other areas of interoperation</li><li>Creating plain JavaScript objects for interaction with external components</li><li>Fixing npm dependencies that use <code>export default</code></li><li>Making sure our Kotlin dependencies support Kotlin/JS IR</li></ul><h2 id=turning-on-ir>Turning on IR</h2><p>To use the IR compiler for our project, we make a small change to our <code>build.gradle(.kts)</code> file. In the <code>kotlin</code> configuration block, change <code>js</code> to <code>js(IR)</code>, and enable the generation of JavaScript artifacts via <code>binaries.executable()</code>:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>js(IR) {
</span></span><span style=display:flex><span>    binaries.executable()
</span></span><span style=display:flex><span>    browser {
</span></span><span style=display:flex><span>        commonWebpackConfig {
</span></span><span style=display:flex><span>            cssSupport.enabled = <span style=color:#fe8019>true</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        testTask {
</span></span><span style=display:flex><span>            useKarma {
</span></span><span style=display:flex><span>                useChromeHeadless()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>(Alternatively, the compiler type can also be set in the <code>gradle.properties</code> file, with the key <code>kotlin.js.compiler=ir</code>, which might be easier if you have a more complex project.)</p><p>We can now cross our fingers and execute the <code>browserDevelopmentRun</code> Gradle task to <strong>start our application</strong>.</p><p>Let&rsquo;s look at some of <strong>the symptoms</strong> our CodeQuiz app exhibited when first running the application with IR, and let&rsquo;s <strong>correct the related code</strong>.</p><h2 id=make-js--and-react-related-classes-external-interfaces>Make JS- and React-related classes external interfaces</h2><p>The <a href=https://kotlinlang.org/docs/js-interop.html#declare-static-members-of-a-class><code>external</code> modifier</a> helps Kotlin understand that a certain <strong>declaration is pure JavaScript</strong>. This prevents problems like <code>ClassCastException</code>s that would arise from the <strong>false assumption</strong> that something is a Kotlin object (like a <code>data class</code>) â€“ even though in reality, we are dealing with a plain JavaScript object.</p><p>When using <code>react-kotlin</code>, this can often be observed regarding definitions of <code>RState</code> and <code>RProps</code> â€“ with React, <strong>state and properties are pure JavaScript objects</strong> managed by the framework for us.</p><h3 id=turn-rstate-into-an-external-interface>Turn RState into an external interface</h3><p>When running my application with IR enabled for the first time, I got the following <code>ClassCastException</code> in regards to some React components&rsquo; <code>init</code> method:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>codequiz<span style=color:#fe8019>-</span>server.js<span style=color:#fe8019>?</span><span style=color:#d3869b>20e3</span><span style=color:#fe8019>:</span><span style=color:#d3869b>19131</span> Uncaught 
</span></span><span style=display:flex><span>ClassCastException {message<span style=color:#fe8019>:</span> <span style=color:#fe8019>undefined</span>, cause<span style=color:#fe8019>:</span> <span style=color:#fe8019>undefined</span>, name<span style=color:#fe8019>:</span> <span style=color:#b8bb26>&#34;ClassCastException&#34;</span>, stack<span style=color:#fe8019>:</span> <span style=color:#b8bb26>&#34;ClassCastExceptionâ†µ    at THROW_CCE (webpack-interâ€¦s/react-dom/cjs/react-dom.development.js:4056:31)&#34;</span>}
</span></span><span style=display:flex><span>cause<span style=color:#fe8019>:</span> <span style=color:#fe8019>undefined</span>
</span></span><span style=display:flex><span>message<span style=color:#fe8019>:</span> <span style=color:#fe8019>undefined</span>
</span></span><span style=display:flex><span>name<span style=color:#fe8019>:</span> <span style=color:#b8bb26>&#34;ClassCastException&#34;</span>
</span></span><span style=display:flex><span>stack<span style=color:#fe8019>:</span> <span style=color:#b8bb26>&#34;ClassCastExceptionâ†µ    at THROW_CCE (webpack-internal:///./kotlin/codequiz-server.js:19101:11)â†µ    at App.init (webpack-internal:///./kotlin/codequiz-server.js:101164:69)â†µ    at RComponent_init_$Init$ (webpack-internal:///./kotlin/codequiz-server.js:31545:11)â†µ    at new App (webpack-internal:///./kotlin/codequiz-server.js:101148:5)â†µ    at constructClassInstance (webpack-internal:///../../node_modules/react-dom/cjs/react-dom.development.js:12716:18)â†µ    at updateClassComponent (webpack-internal:///../../node_modules/react-dom/cjs/react-dom.development.js:17425:5)â†µ    at beginWork (webpack-internal:///../../node_modules/react-dom/cjs/react-dom.development.js:19073:16)â†µ    at HTMLUnknownElement.callCallback (webpack-internal:///../../node_modules/react-dom/cjs/react-dom.development.js:3945:14)â†µ    at Object.invokeGuardedCallbackDev (webpack-internal:///../../node_modules/react-dom/cjs/react-dom.development.js:3994:16)â†µ    at invokeGuardedCallback (webpack-internal:///../../node_modules/react-dom/cjs/react-dom.development.js:4056:31)&#34;</span>
</span></span><span style=display:flex><span>__proto__<span style=color:#fe8019>:</span> RuntimeException
</span></span><span style=display:flex><span>THROW_CCE	@	codequiz<span style=color:#fe8019>-</span>server.js<span style=color:#fe8019>?</span><span style=color:#d3869b>20e3</span><span style=color:#fe8019>:</span><span style=color:#d3869b>19131</span>
</span></span><span style=display:flex><span>App.init	@	codequiz<span style=color:#fe8019>-</span>server.js<span style=color:#fe8019>?</span><span style=color:#d3869b>20e3</span><span style=color:#fe8019>:</span><span style=color:#d3869b>101224</span>
</span></span></code></pre></div><p>The stack trace suggests the <code>init</code> method of my <code>App</code> component. Since here, only application state is initialized, it was quite easy to pinpoint the underlying problem.</p><p>The <strong>offending code</strong> for the application state looks like this:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#fe8019>interface</span> AppState : RState {
</span></span><span style=display:flex><span>    <span style=color:#fe8019>var</span> isPresenter: Boolean
</span></span><span style=display:flex><span>    <span style=color:#fe8019>var</span> lastMessage: Content?
</span></span><span style=display:flex><span>    <span style=color:#fe8019>var</span> isConnected: Boolean
</span></span><span style=display:flex><span>    <span style=color:#fe8019>var</span> chosenName: String?
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This code <em>happened</em> to work with the legacy compiler, but the IR compiler marks our problem: if our interface <strong>describes the exact shape of a <em>JavaScript object</em></strong>, we need to <strong>mark the interface as <code>external</code></strong>.</p><p>The refactored code looks like this:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#fe8019>external</span> <span style=color:#fe8019>interface</span> AppState : RState {
</span></span><span style=display:flex><span>    <span style=color:#928374;font-style:italic>// . . .
</span></span></span></code></pre></div><p>I made sure that all interfaces implementing <code>RState</code> in my application were annotated with <code>external</code> by using a <a href=https://www.jetbrains.com/help/idea/structural-search-and-replace.html><strong>structural search and replace</strong></a>. If you&rsquo;re using IntelliJ IDEA 2021.1, you can copy an <a href=https://gist.github.com/SebastianAigner/62119536f24597e630acfdbd14001b98>SSR template I prepared</a> into your clipboard. To use it, open SSR via File | Find | Find Structurally [or Replace Structurally], click on the wrench icon, and select &ldquo;Import Template from Clipboard&rdquo;. You can then click &ldquo;Find&rdquo; and &ldquo;Replace All&rdquo; to annotate all interfaces properly.</p><h3 id=turn-rprops-into-an-external-interface>Turn RProps into an external interface</h3><p><code>RState</code> isn&rsquo;t the only type that is affected by this change â€“ similar problems appear when React properties (<code>RProps</code>) aren&rsquo;t marked as external:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>codequiz<span style=color:#fe8019>-</span>server.js<span style=color:#fe8019>?</span><span style=color:#d3869b>20e3</span><span style=color:#fe8019>:</span><span style=color:#d3869b>100446</span> Uncaught TypeError<span style=color:#fe8019>:</span> $this$attrs._set_presenterStartGameHandler_ is not a <span style=color:#fe8019>function</span>
</span></span><span style=display:flex><span>    at _no_name_provided__346.invoke_547 (codequiz<span style=color:#fe8019>-</span>server.js<span style=color:#fe8019>?</span><span style=color:#d3869b>20e3</span><span style=color:#fe8019>:</span><span style=color:#d3869b>100446</span>)
</span></span><span style=display:flex><span>    at <span style=color:#fabd2f>eval</span> (codequiz<span style=color:#fe8019>-</span>server.js<span style=color:#fe8019>?</span><span style=color:#d3869b>20e3</span><span style=color:#fe8019>:</span><span style=color:#d3869b>101430</span>)
</span></span><span style=display:flex><span>    at RElementBuilder.attrs_0 (codequiz<span style=color:#fe8019>-</span>server.js<span style=color:#fe8019>?</span><span style=color:#d3869b>20e3</span><span style=color:#fe8019>:</span><span style=color:#d3869b>31443</span>)
</span></span></code></pre></div><p>Analogously, this results from the <code>RProps</code> definition being just a Kotlin <code>interface</code>:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#fe8019>interface</span> LobbyProps : RProps {
</span></span><span style=display:flex><span>    <span style=color:#fe8019>var</span> isPresenter: Boolean
</span></span><span style=display:flex><span>    <span style=color:#fe8019>var</span> presenterStartGameHandler: () <span style=color:#fe8019>-&gt;</span> Unit
</span></span><span style=display:flex><span>    <span style=color:#fe8019>var</span> playerLoginHandler: (String) <span style=color:#fe8019>-&gt;</span> Unit
</span></span><span style=display:flex><span>    <span style=color:#fe8019>var</span> playerList: PlayerList?
</span></span><span style=display:flex><span>    <span style=color:#fe8019>var</span> isDisabled: Boolean
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The IR-approved versions of this code uses an <code>external interface</code>:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#fe8019>external</span> <span style=color:#fe8019>interface</span> LobbyProps : RProps {
</span></span><span style=display:flex><span>    <span style=color:#928374;font-style:italic>// . . .
</span></span></span></code></pre></div><p>Once again, this change can just be repeated for all components defining <code>RProps</code> interfaces in the Kotlin/JS application. This is easily automated via <strong>structural search and replace</strong>, as described in the previous section. <a href=https://gist.github.com/SebastianAigner/a47a77f5e519fc74185c077ba12624f9>Here is a template</a> for auto-annotating your <code>RProps</code> as <code>external</code> â€“ instructions for using SSR can be found in the previous section.</p><h3 id=use-external-interfaces-over-data-classes>Use external interfaces over data classes!</h3><p>If you&rsquo;ve been using Kotlin&rsquo;s <code>class</code> or <code>data class</code> to create your <code>RProps</code> or <code>RState</code>s, you will need to do a similar refactoring. Code like this is invalid when using Kotlin/JS IR:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#fe8019>data</span> <span style=color:#fe8019>class</span> CustomComponentState(
</span></span><span style=display:flex><span>   <span style=color:#fe8019>var</span> name: String
</span></span><span style=display:flex><span>) : RState
</span></span></code></pre></div><p>Instead, use the following, refactored version.</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#fe8019>external</span> <span style=color:#fe8019>interface</span> CustomComponentState: RState {
</span></span><span style=display:flex><span>   <span style=color:#fe8019>var</span> name: String
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=address-limitations-of-external-interfaces>Address limitations of external interfaces</h3><p>Compared to a Kotlin <code>interface</code> or <code>class</code>, there are a few <strong>limitations</strong> when using <code>external interface</code>.</p><p>If you want to <strong>instantiate the interface from Kotlin code</strong>, you will have to mark your properties as <code>var</code> (<code>val</code> will not work here). Also, certain Kotlin-specific constructs, such as <strong>function types with receivers, are prohibited</strong> in external declarations.</p><p>In our codebase, the latter showed up as a <strong>compile error</strong> in an interface called <code>ButtonProps</code>. Here, we define a property <code>inside</code> which takes an extension function on the <code>StyledDOMBuilder</code> type to define any components that should be rendered in the button:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#fe8019>external</span> <span style=color:#fe8019>interface</span> ButtonProps : RProps {
</span></span><span style=display:flex><span>    <span style=color:#fe8019>var</span> inside: StyledDOMBuilder&lt;BUTTON&gt;.() <span style=color:#fe8019>-&gt;</span> Unit
</span></span><span style=display:flex><span>    <span style=color:#928374;font-style:italic>// . . .
</span></span></span><span style=display:flex><span><span style=color:#928374;font-style:italic></span>}
</span></span></code></pre></div><p>Since these functions with receivers are just <strong>syntactic sugar</strong> for a function with an (implicitly named) parameter of the same type, we can refactor the <code>external interface</code> and pass the <code>StyledDOMBuilder</code> explicitly, resolving this problem:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#fe8019>var</span> inside: (StyledDOMBuilder&lt;BUTTON&gt;) <span style=color:#fe8019>-&gt;</span> Unit
</span></span></code></pre></div><p>As luck would have it, our <strong>callsite</strong> was already structured so that this slightly changed style of function definition just works, so no change was needed there:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>styledButton {
</span></span><span style=display:flex><span>    props.inside(<span style=color:#fe8019>this</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    attrs {
</span></span><span style=display:flex><span>        <span style=color:#928374;font-style:italic>// . . .
</span></span></span><span style=display:flex><span><span style=color:#928374;font-style:italic></span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=create-plain-js-objects-for-interoperability>Create plain JS objects for interoperability</h2><p>Inside the definition of a React component, objects implementing <code>RState</code> and <code>RProps</code> <strong>already exist</strong>, and we simply <strong>modify their properties</strong>.</p><p>When we <strong>create these objects</strong> ourselves, we (currently still) need to be a bit careful. In CodeQuiz, we had the following problem passing values to an external <a href=https://www.npmjs.com/package/react-minimal-pie-chart><code>react-minimal-pie-chart</code></a> component:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>PieChart.default {
</span></span><span style=display:flex><span>    attrs {
</span></span><span style=display:flex><span>        <span style=color:#fe8019>data</span> = props.statistics.answers.mapIndexed { index, (_, answerCounts) <span style=color:#fe8019>-&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#fe8019>object</span>: PiePoint {
</span></span><span style=display:flex><span>                <span style=color:#fe8019>override</span> <span style=color:#fe8019>var</span> title = <span style=color:#b8bb26>&#34;Number </span><span style=color:#b8bb26>$index</span><span style=color:#b8bb26>&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#fe8019>override</span> <span style=color:#fe8019>var</span> value = answerCounts
</span></span><span style=display:flex><span>                <span style=color:#928374;font-style:italic>// . . .
</span></span></span><span style=display:flex><span><span style=color:#928374;font-style:italic></span>            }
</span></span><span style=display:flex><span>        }.toTypedArray()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>&mldr;and that even though <code>PiePoint</code> is correctly specified as an <code>external interface</code>. The specific issue here turned out to be a bit finicky:</p><p>As of now, properties on a Kotlin <code>object</code> implementing an <code>external interface</code> are <strong><em>accessible</em></strong> from JavaScript, but, for example, they are <a href=https://youtrack.jetbrains.com/issue/KT-31876><strong>not <em>enumberable</em></strong></a>. <code>react-minimal-pie-chart</code> internally uses <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign><code>Object.assign</code></a> to copy around some of the data we pass as props. <strong>It loses our non-enumerable properties</strong> in the process, which leads to some unexpected <code>undefined</code>s at runtime.</p><p>Until this problem is resolved (see the <a href=https://youtrack.jetbrains.com/issue/KT-17683>corresponding YouTrack issue</a>), the safe route right now is to <strong>generate plain JavaScript objects</strong> ourselves.</p><p>The <code>kotlin-wrappers</code> actually include a <strong>helper function</strong> called <a href=https://github.com/JetBrains/kotlin-wrappers/blob/master/kotlin-extensions/src/main/kotlin/kotlinext/js/Helpers.kt><code>jsObject&lt;T></code></a> which is useful for creating such objects. The same snippet using these plain JavaScript objects looks like this:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>PieChart.default {
</span></span><span style=display:flex><span>    attrs {
</span></span><span style=display:flex><span>        <span style=color:#fe8019>data</span> = props.statistics.answers.mapIndexed { index, (_, answerCounts) <span style=color:#fe8019>-&gt;</span>
</span></span><span style=display:flex><span>            jsObject&lt;PiePoint&gt; {
</span></span><span style=display:flex><span>                title = <span style=color:#b8bb26>&#34;Number </span><span style=color:#b8bb26>$index</span><span style=color:#b8bb26>&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#fe8019>value</span> = answerCounts
</span></span><span style=display:flex><span>                <span style=color:#928374;font-style:italic>// . . .
</span></span></span><span style=display:flex><span><span style=color:#928374;font-style:italic></span>            }
</span></span><span style=display:flex><span>        }.toTypedArray()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Since in a plain JavaScript object, all properties are enumerable, our charting library now works properly.</p><h2 id=help-the-dce-via-jsexport>Help the DCE via @JsExport!</h2><p>Dead Code Elimination (DCE) is the part of the Kotlin/JS IR compiler that helps <strong>keep your compiled production artifacts small</strong>. It&rsquo;s responsible for analyzing the Kotlin code for any pieces of code that aren&rsquo;t being used anywhere, and subsequently deleting them.</p><p>When packaging our application for production (which is when DCE is executed, e.g. via <code>browserProductionRun</code> or <code>jsBrowserDistribution</code>), this can present a <strong>problem</strong> for our <strong>React components</strong>.</p><p>Consider the following <code>Evaluation</code> class from our project:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#fe8019>class</span> Evaluation(l: EvaluationProps) : RComponent&lt;EvaluationProps, RState&gt;(l) {
</span></span><span style=display:flex><span>    <span style=color:#fe8019>override</span> <span style=color:#fe8019>fun</span> <span style=color:#fabd2f>RBuilder</span>.render() {
</span></span></code></pre></div><p>The only way this class is ever referenced via its <a href=https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.reflect/-k-class/><code>KClass</code></a>, when we tell React to render this component:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>child(Evaluation<span style=color:#fe8019>::</span><span style=color:#fe8019>class</span>) {
</span></span><span style=display:flex><span>    attrs {
</span></span><span style=display:flex><span>            <span style=color:#928374;font-style:italic>// . . .
</span></span></span></code></pre></div><p>As of now, the IR DCE tries to be a bit too clever for its own good. <strong>It removes the contents of our class</strong> practically entirely (from its perspective, none of it, besides the type itself, is being used after all!). This causes the (unfortunately quite cryptic) error <code>TypeError: r.render is not a function</code> (or something similar).</p><p>To turn this error message into something a bit more actionable, we can (temporarily!) <strong>enable webpack&rsquo;s development mode</strong> in our Gradle build file (<code>build.gradle(.kts)</code>), which turns off the name minification:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>browser {
</span></span><span style=display:flex><span>    commonWebpackConfig {
</span></span><span style=display:flex><span>        <span style=color:#928374;font-style:italic>// . . .
</span></span></span><span style=display:flex><span><span style=color:#928374;font-style:italic></span>        mode = org.jetbrains.kotlin.gradle.targets.js.webpack.KotlinWebpackConfig.Mode.DEVELOPMENT
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>For now, we need to make sure our component doesn&rsquo;t get removed, we can <strong>mark the class</strong> with <code>@JsExport</code>. Then, DCE will not touch it:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>@JsExport
</span></span><span style=display:flex><span><span style=color:#fe8019>class</span> Evaluation(l: EvaluationProps) : RComponent&lt;EvaluationProps, RState&gt;(l) {
</span></span><span style=display:flex><span>    <span style=color:#fe8019>override</span> <span style=color:#fe8019>fun</span> <span style=color:#fabd2f>RBuilder</span>.render() {
</span></span></code></pre></div><p>(As a small sidenote: declarations marked as <code>external</code>, such as an <code>external interface</code>, are always treated as reachable by DCE, and don&rsquo;t need this treatment. <a href=https://github.com/JetBrains/kotlin-wrappers/blob/master/kotlin-react/README.md#creating-a-react-function-component-with-kotlin>Functional components</a> are also not affected, because their usage site doesn&rsquo;t refer to the <code>::class</code>, but to the variable holding the component directly.)</p><p>In the case of <code>kotlin-react</code>, there are still <strong>some rough edges</strong>, like the warning <code>Exported declaration uses non-exportable super type: RComponent</code>. Together with making this kind of &ldquo;workaround&rdquo; obsolete, these are topics that still need addressing before the IR compiler becomes the default choice.</p><p>You can find a Structural Search and Replace template for this change <a href=https://gist.github.com/SebastianAigner/b06f50b1448f6466775b0df14fb2b35f>right here</a>. Find instructions on how to apply this automated replacement to your project in one of the previous paragraphs.</p><p>This is definitely one of the trickier issues to find, because it <strong>only manifests in production artifacts</strong> (when DCE is actually executed). For this reason, it&rsquo;s important to <strong>test your production artifacts</strong>!</p><h2 id=fixing-dependencies-on-default-exports>Fixing dependencies on default exports</h2><p>Our app uses a few external React components which we get from npm, including <code>react-minimal-pie-chart</code>.</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>Module parse failed<span style=color:#fe8019>:</span> Unexpected keyword <span style=color:#b8bb26>&#39;default&#39;</span> (<span style=color:#d3869b>35</span><span style=color:#fe8019>:</span><span style=color:#d3869b>6</span>)
</span></span><span style=display:flex><span>File was processed <span style=color:#fe8019>with</span> these loaders<span style=color:#fe8019>:</span>
</span></span><span style=display:flex><span> <span style=color:#fe8019>*</span> ..<span style=color:#fe8019>/</span>..<span style=color:#fe8019>/</span>node_modules<span style=color:#fe8019>/</span>source<span style=color:#fe8019>-</span>map<span style=color:#fe8019>-</span>loader<span style=color:#fe8019>/</span>dist<span style=color:#fe8019>/</span>cjs.js
</span></span><span style=display:flex><span>You may need an additional loader to handle the result <span style=color:#fe8019>of</span> these loaders.
</span></span><span style=display:flex><span><span style=color:#fe8019>|</span>   <span style=color:#fe8019>var</span> render <span style=color:#fe8019>=</span> $module$react_dom.render;
</span></span><span style=display:flex><span><span style=color:#fe8019>|</span>   <span style=color:#fe8019>var</span> createGlobalStyle <span style=color:#fe8019>=</span> $module$styled_components.createGlobalStyle;
</span></span><span style=display:flex><span><span style=color:#fe8019>&gt;</span>   <span style=color:#fe8019>var</span> <span style=color:#fe8019>default</span> <span style=color:#fe8019>=</span> $module$react_minimal_pie_chart.<span style=color:#fe8019>default</span>;
</span></span><span style=display:flex><span><span style=color:#fe8019>|</span>   <span style=color:#fe8019>var</span> <span style=color:#fe8019>default</span> <span style=color:#fe8019>=</span> $module$react_player.<span style=color:#fe8019>default</span>;
</span></span><span style=display:flex><span><span style=color:#fe8019>|</span>   <span style=color:#b8bb26>&#39;use strict&#39;</span>;
</span></span></code></pre></div><p>We wrote the following external declaration for the component provided by this package, which worked for our used version, <code>5.0.2</code>, beforehand, but not with IR:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>@file:JsModule(<span style=color:#b8bb26>&#34;react-minimal-pie-chart&#34;</span>)
</span></span><span style=display:flex><span>@file:JsNonModule
</span></span><span style=display:flex><span><span style=color:#fe8019>external</span> <span style=color:#fe8019>interface</span> PieChartProps: RProps {
</span></span><span style=display:flex><span>    <span style=color:#928374;font-style:italic>// . . .
</span></span></span><span style=display:flex><span><span style=color:#928374;font-style:italic></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@JsName(<span style=color:#b8bb26>&#34;default&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#fe8019>external</span> <span style=color:#fe8019>val</span> PieChart: RClass&lt;PieChartProps&gt;
</span></span></code></pre></div><p>Here, we actually hit <strong>a bug in the IR compiler</strong>! It currently does not treat <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/export#description><code>default</code></a> as a reserved identifier. This causes a conflict when the library uses this identifier for its exports:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#fe8019>import</span> Chart from <span style=color:#b8bb26>&#39;./Chart&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#fe8019>export</span> <span style=color:#fe8019>default</span> Chart;
</span></span></code></pre></div><p><a href=https://youtrack.jetbrains.com/issue/KT-41650>An issue</a> exists to turn <code>default</code> into a reserved identifier, and this point will hopefully be addressed soon. Until then, the <strong>workaround</strong> is to wrap the definition in an external object, like so:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#fe8019>external</span> <span style=color:#fe8019>interface</span> PieChartProps : RProps {
</span></span><span style=display:flex><span>    <span style=color:#928374;font-style:italic>// . . .
</span></span></span><span style=display:flex><span><span style=color:#928374;font-style:italic></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@JsModule(<span style=color:#b8bb26>&#34;react-minimal-pie-chart&#34;</span>)
</span></span><span style=display:flex><span>@JsNonModule
</span></span><span style=display:flex><span><span style=color:#fe8019>external</span> <span style=color:#fe8019>object</span> PieChart {
</span></span><span style=display:flex><span>    <span style=color:#fe8019>val</span> default: RClass&lt;PieChartProps&gt;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>At the usage site for the component, we now use the <code>PieChart.default</code> value instead of the <code>PieChart</code> value previously:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>PieChart.default {
</span></span><span style=display:flex><span>    attrs {
</span></span><span style=display:flex><span>        <span style=color:#928374;font-style:italic>// . . .
</span></span></span><span style=display:flex><span><span style=color:#928374;font-style:italic></span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=fix-library-code>Fix library code</h2><p>After fixing all of the other problems, I noticed a special case where the app would throw the following error:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>Uncaught <span style=color:#fabd2f>Error</span><span style=color:#fe8019>:</span> <span style=color:#b8bb26>`props.dangerouslySetInnerHTML`</span> must be <span style=color:#fe8019>in</span> the form <span style=color:#b8bb26>`{__html: ...}`</span>. Please visit https<span style=color:#fe8019>:</span><span style=color:#928374;font-style:italic>//reactjs.org/link/dangerously-set-inner-html for more information.
</span></span></span></code></pre></div><p>It took me a while to find the culprit, but I remembered that there was a place where we explicitly allowed HTML-formatted rich text in our application, and are using <code>unsafe</code>:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#fe8019>val</span> label: RBuilder.() <span style=color:#fe8019>-&gt;</span> Unit = {
</span></span><span style=display:flex><span>    span {
</span></span><span style=display:flex><span>        attrs.unsafe {
</span></span><span style=display:flex><span>            +answerText
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It turns out that <code>kotlin-wrappers</code> actually <a href=https://github.com/JetBrains/kotlin-wrappers/pull/416><strong>contained a small mistake</strong></a> in its own interoperation code: it used a <code>class</code> instead of an <code>external interface</code> for their <code>InnerHTML</code> object â€“ which is used to implement <code>attrs.unsafe</code>.</p><p>This was a great point to <strong>make a small open-source contribution</strong> in the form of a pull request (and get the code improved further just <a href=https://github.com/JetBrains/kotlin-wrappers/pull/418>hours later</a>)!</p><h2 id=petition-library-authors-to-support-ir>Petition library authors to support IR</h2><p>Luckily, all the libraries we are using in the project (including <a href=https://ktor.io/>Ktor Clients</a> and <a href=https://github.com/Kotlin/kotlinx.serialization>kotlinx.serialization</a>) already support the Kotlin/JS IR compiler, and they provide artifacts that work with both backends. And there is a number of other libraries that already offer artifacts compatible with the IR compiler, like <a href=https://www.fritz2.dev/>fritz2</a>, <a href=https://github.com/korlibs/korge>KorGE</a>, <a href=https://github.com/Kodein-Framework/Kodein-DI>Kodein-DI</a>, and more.</p><p>If you&rsquo;re using a Kotlin/JS library that currently does not ship IR-compatible artifacts, it might be a good idea to <strong>catch the maintainer&rsquo;s attention</strong>, and maybe <strong>help out</strong> yourself to ensure that your favorite libraries work well with the new compiler infrastructure. To make sure libraries can support both legacy and IR backends at the same time, there is also a mechanism for <a href=https://kotlinlang.org/docs/js-ir-compiler.html#authoring-libraries-for-the-ir-compiler-with-backwards-compatibility>authoring libraries with backwards compatibility</a>.</p><p>If you&rsquo;re a <strong>library author</strong>, and want to learn more about supporting the Kotlin/JS IR backend, please do not hesitate to reach out on the <a href=http://kotl.in/slack>Kotlinlang Slack</a>. You can either contact me directly, or get input from the team and community in the <code>#javascript</code> channel.</p><h2 id=closing-thoughts>Closing thoughts</h2><p>The new IR compiler introduces some changes that might require action from you â€“ especially in places where Kotlin code meets the JavaScript platform. I hope this post helps diagnose some of these behavior changes, so that you can experience all the <strong>exciting stuff</strong> the new compiler brings as soon as possible.</p><p>If you encounter issues during your migration to the IR backend, share them with the team. We&rsquo;re happy to help, and rely on your feedback to make sure we can iron out any remaining problems as soon as possible. The easiest way to do this is to log your problems in the official Kotlin <a href=http://kotl.in/issue>issue tracker</a>.</p><p>Give the Kotlin/JS IR compiler a try in your projects, and prepare yourself for the future!</p><div><div>Tags:</div><ul><li><a href=/tags/kotlin/>kotlin</a></li><li><a href=/tags/javascript/>javascript</a></li></ul></div></div></div></main><footer><footer class="site-footer h-card"><data class=u-url href></data><div class=wrapper><div class=footer-col-wrapper><div class=footer-col><p class=feed-subscribe><svg class="svg-icon orange"/><span>Subscribe</span></a></p><ul class=contact-list></ul></div><div class=footer-col><p>Thanks for stopping by my corner of the internet :)</p></div></div></div></footer></footer></body></html>